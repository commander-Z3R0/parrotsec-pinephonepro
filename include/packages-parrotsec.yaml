{{- $architecture := or .architecture "arm64" -}}

architecture: {{ $architecture }}

actions:
  - action: apt
    description: Install base dependencies required for Parrot bootstrap
    recommends: false
    packages:
      - ca-certificates
      - wget
      - gnupg
      - apt-transport-https

  # ------------------------------------------------------------
  # Parrot conversion (BUILD-ONLY)
  # Executed inline to avoid leaving build scripts in the image
  # ------------------------------------------------------------
  - action: run
    description: Convert Mobian base into Parrot core (minimal, inline execution)
    chroot: true
    command: |
      bash -s <<'EOF'
      set -e
      export DEBIAN_FRONTEND=noninteractive

      echo "[+] Blocking service startup during package installation"
      cat << 'POLICY' > /usr/sbin/policy-rc.d
      #!/bin/sh
      exit 101
      POLICY
      chmod +x /usr/sbin/policy-rc.d

      echo "[+] Installing Parrot archive keyring"
      wget -q https://deb.parrot.sh/parrot/pool/main/p/parrot-archive-keyring/parrot-archive-keyring_2024.12_all.deb
      apt-get install -y ./parrot-archive-keyring_2024.12_all.deb
      rm -f parrot-archive-keyring_2024.12_all.deb

      echo "[+] Removing duplicate Mobian sources"
      rm -f /etc/apt/sources.list.d/mobian.list || true

      echo "[+] Adding Parrot repositories"
      cat << 'APT' > /etc/apt/sources.list.d/parrot.list
      deb https://deb.parrot.sh/parrot echo main contrib non-free non-free-firmware
      deb https://deb.parrot.sh/parrot echo-security main contrib non-free non-free-firmware
      deb https://deb.parrot.sh/parrot echo-backports main contrib non-free non-free-firmware
      APT

      echo "[+] APT pinning (Mobian preferred)"
      cat << 'PIN' > /etc/apt/preferences.d/00-mobian
      Package: *
      Pin: origin repo.mobian.org
      Pin-Priority: 900
      PIN

      echo "[+] Allow Parrot packages (tools only)"
      cat << 'PIN' > /etc/apt/preferences.d/10-parrot
      Package: parrot-*
      Pin: origin deb.parrot.sh
      Pin-Priority: 650
      PIN

      echo "[+] Block GNOME desktop packages"
      cat << 'PIN' > /etc/apt/preferences.d/99-block-gnome
      Package: gnome-*
      Pin: origin
      Pin-Priority: -1
      PIN

      apt-get update

      apt-mark hold apparmor apparmor-profiles apparmor-profiles-extra || true

      echo "[+] Installing Parrot base components"
      apt-get install -y --no-install-recommends \
        -o Dpkg::Options::=--force-confdef \
        -o Dpkg::Options::=--force-confold \
        parrot-menu \
        parrot-themes

      dpkg --configure -a || true
      apt-get -f install -y || true

      rm -f /usr/sbin/policy-rc.d

      echo "[+] Parrot conversion completed"
      EOF

  # ------------------------------------------------------------
  # Install Parrot user-facing commands into /usr/bin
  # These ARE part of the final image
  # ------------------------------------------------------------
  - action: overlay
    description: Install Parrot CLI tools
    source: parrot-script/usr/bin/
    destination: /usr/bin/

  - action: overlay
    description: Install Parrot OS Release
    source: parrot-script/usr/lib/
    destination: /usr/lib/
 
  - action: overlay
    description: Replace Mobian Plymouth logo with custom Parrot logo
    source: parrot-script/usr/share/plymouth/themes/mobian/logo.png
    destination: /usr/share/plymouth/themes/mobian/logo.png
    
  - action: run
    description: Fix permissions for Parrot CLI tools
    chroot: true
    command: |
      chmod +x /usr/bin/parrot-*

